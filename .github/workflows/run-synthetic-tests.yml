name: Run Synthetic Tests


on:
  workflow_dispatch:

jobs:  
  CheckIfRunning:
    uses: THD-C/The_THDc_App/.github/workflows/check-self-hosted-runner.yml@main
    secrets: inherit
  
  RunSyntheticTests:
    needs: CheckIfRunning
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Remove container if exists
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
      - name: Build Docker Image
        run: docker compose build

      - name: Run Synthetic Tests
        shell: pwsh
        run: |
          docker compose up --force-recreate
          
          $ContainerStatus = $(docker compose ps -a --format=json | ConvertFrom-Json)
          
          docker compose down

          if ($ContainerStatus -ne 0){
            throw "Synthetic Tests failed"
          }
